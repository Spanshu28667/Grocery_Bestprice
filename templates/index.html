document.addEventListener("DOMContentLoaded", () => {
    const searchForm = document.getElementById("searchForm");
    const productInput = document.getElementById("productName");
    const resultsSection = document.getElementById("resultsSection");
    const resultsTableBody = document.getElementById("resultsTableBody");
    const queryText = document.getElementById("queryText");
    const bestDealSection = document.getElementById("bestDealSection");
    const bestDealText = document.getElementById("bestDealText");
    const errorSection = document.getElementById("errorSection");
    const errorText = document.getElementById("errorText");
    const searchBtnText = document.getElementById("searchBtnText");
    const searchBtnSpinner = document.getElementById("searchBtnSpinner");

    searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const product = productInput.value.trim();
        if (!product) return;

        // Show spinner
        searchBtnText.classList.add("d-none");
        searchBtnSpinner.classList.remove("d-none");

        resultsSection.classList.add("d-none");
        errorSection.classList.add("d-none");
        bestDealSection.classList.add("d-none");

        try {
            const res = await fetch(`/search?q=${encodeURIComponent(product)}`);
            const data = await res.json();

            // Check for error from backend
            if (data.error) {
                throw new Error(data.error);
            }

            // Populate results table
            resultsTableBody.innerHTML = "";
            queryText.textContent = product;

            let bestPrice = Infinity;
            let bestPlatform = "";

            data.platforms.forEach(p => {
                const row = document.createElement("tr");

                const platformCell = document.createElement("td");
                platformCell.textContent = p.platform;

                const nameCell = document.createElement("td");
                nameCell.textContent = p.product_name;

                const priceCell = document.createElement("td");
                priceCell.textContent = p.price;

                const statusCell = document.createElement("td");
                statusCell.textContent = p.available ? "‚úÖ Available" : "‚ùå Not Found";

                const linkCell = document.createElement("td");
                const link = document.createElement("a");
                link.href = p.url;
                link.target = "_blank";
                link.textContent = "üîó View";
                linkCell.appendChild(link);

                row.append(platformCell, nameCell, priceCell, statusCell, linkCell);
                resultsTableBody.appendChild(row);

                // Track best deal
                if (p.available && p.price !== 'N/A') {
                    let priceValue = parseFloat(p.price.replace('‚Çπ','').replace(',','').trim());
                    if (!isNaN(priceValue) && priceValue < bestPrice) {
                        bestPrice = priceValue;
                        bestPlatform = p.platform;
                    }
                }
            });

            resultsSection.classList.remove("d-none");

            if (bestPlatform) {
                bestDealText.textContent = `${bestPlatform} has the lowest price of ‚Çπ${bestPrice}`;
                bestDealSection.classList.remove("d-none");
            }

        } catch (err) {
            errorText.textContent = err.message || "Something went wrong!";
            errorSection.classList.remove("d-none");
        } finally {
            // Hide spinner
            searchBtnText.classList.remove("d-none");
            searchBtnSpinner.classList.add("d-none");
        }
    });
});
